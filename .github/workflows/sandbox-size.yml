name: sandbox-size

on:
  push:
    branches: ["master"]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-wasm:
    if: github.actor != 'github-actions[bot]'
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
    steps:
      - uses: actions/checkout@v4
      - name: Set up Emscripten
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: 4.0.19
      - name: Configure web debug
        run: cmake --preset web-debug -DNT_PROJECT_SANDBOX=ON -DNT_ENABLE_WEBGPU=ON
      - name: Build web debug
        run: cmake --build --preset web-debug
      - name: Configure web release
        run: cmake --preset web-release -DNT_PROJECT_SANDBOX=ON -DNT_ENABLE_WEBGPU=ON
      - name: Build web release
        run: cmake --build --preset web-release
      - name: Stage sandbox artifacts
        run: |
          $ErrorActionPreference = 'Stop'
          Remove-Item -Recurse -Force size-inputs -ErrorAction SilentlyContinue
          if (-not (Test-Path output\sandbox\wasm\debug)) {
            throw "Expected output\sandbox\wasm\debug to exist after build."
          }
          if (-not (Test-Path output\sandbox\wasm\release)) {
            throw "Expected output\sandbox\wasm\release to exist after build."
          }
          New-Item -ItemType Directory -Force -Path size-inputs\sandbox\wasm\debug | Out-Null
          Copy-Item -Path output\sandbox\wasm\debug\* -Destination size-inputs\sandbox\wasm\debug -Recurse -Force
          New-Item -ItemType Directory -Force -Path size-inputs\sandbox\wasm\release | Out-Null
          Copy-Item -Path output\sandbox\wasm\release\* -Destination size-inputs\sandbox\wasm\release -Recurse -Force
      - name: Upload sandbox wasm artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sandbox-wasm
          path: size-inputs
          retention-days: 3

  build-windows:
    if: github.actor != 'github-actions[bot]'
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Configure win debug
        shell: pwsh
        run: cmake --preset win-debug -DNT_PROJECT_SANDBOX=ON -DNT_ENABLE_WEBGPU=ON
      - name: Build win debug
        shell: pwsh
        run: cmake --build --preset win-debug
      - name: Configure win release
        shell: pwsh
        run: cmake --preset win-release -DNT_PROJECT_SANDBOX=ON -DNT_ENABLE_WEBGPU=ON
      - name: Build win release
        shell: pwsh
        run: cmake --build --preset win-release
      - name: Stage sandbox artifacts
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          Remove-Item -Recurse -Force size-inputs -ErrorAction SilentlyContinue
          New-Item -ItemType Directory -Force -Path size-inputs\sandbox\windows\debug | Out-Null
          Copy-Item -Path output\sandbox\windows\debug\* -Destination size-inputs\sandbox\windows\debug -Recurse -Force
          New-Item -ItemType Directory -Force -Path size-inputs\sandbox\windows\release | Out-Null
          Copy-Item -Path output\sandbox\windows\release\* -Destination size-inputs\sandbox\windows\release -Recurse -Force
      - name: Upload sandbox windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sandbox-windows
          path: size-inputs
          retention-days: 3

  update-size-reports:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    needs:
      - build-wasm
      - build-windows
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Download wasm artifacts
        uses: actions/download-artifact@v4
        with:
          name: sandbox-wasm
          path: artifact-inputs/wasm
          merge-multiple: true
      - name: Download windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: sandbox-windows
          path: artifact-inputs/windows
          merge-multiple: true
      - name: Stage sandbox outputs
        run: |
          set -euo pipefail
          rm -rf output
          mkdir -p output/sandbox/wasm/debug
          mkdir -p output/sandbox/wasm/release
          mkdir -p output/sandbox/windows/debug
          mkdir -p output/sandbox/windows/release
          find_dir() {
            local search_root=$1
            local pattern=$2
            find "$search_root" -type d -path "$pattern" | head -n 1
          }
          wasm_debug=$(find_dir artifact-inputs/wasm "*/sandbox/wasm/debug")
          wasm_release=$(find_dir artifact-inputs/wasm "*/sandbox/wasm/release")
          windows_debug=$(find_dir artifact-inputs/windows "*/sandbox/windows/debug")
          windows_release=$(find_dir artifact-inputs/windows "*/sandbox/windows/release")
          if [ -z "${wasm_debug:-}" ] || [ -z "${wasm_release:-}" ]; then
            echo "Unable to locate wasm sandbox directories"
            ls -R artifact-inputs/wasm || true
            exit 1
          fi
          if [ -z "${windows_debug:-}" ] || [ -z "${windows_release:-}" ]; then
            echo "Unable to locate windows sandbox directories"
            ls -R artifact-inputs/windows || true
            exit 1
          fi
          cp -a "$wasm_debug/." output/sandbox/wasm/debug/
          cp -a "$wasm_release/." output/sandbox/wasm/release/
          cp -a "$windows_debug/." output/sandbox/windows/debug/
          cp -a "$windows_release/." output/sandbox/windows/release/
      - name: Update size reports
        run: |
          set -euo pipefail
          python3 reports/size/update.py --input output/sandbox/wasm/debug --output sandbox/wasm/debug
          python3 reports/size/update.py --input output/sandbox/wasm/release --output sandbox/wasm/release
          python3 reports/size/update.py --input output/sandbox/windows/debug --output sandbox/windows/debug
          python3 reports/size/update.py --input output/sandbox/windows/release --output sandbox/windows/release
      - name: Commit size report updates
        run: |
          set -euo pipefail
          changes=$(git status --short reports/size)
          if [ -z "$changes" ]; then
            echo "No size report changes to commit."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add reports/size
          git commit -m "chore: update sandbox size reports"
          git push
      - name: Upload size report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: size-report-dashboard
          path: reports/size
          retention-days: 3
