name: web-release

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * *'

jobs:
  web-release-build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        preset: [web-release]
    steps:
      - uses: actions/checkout@v4
      - name: Format check
        run: ci/scripts/run-format-check.sh --all
      - name: Clang-Tidy gate
        run: tests/ci/test_clang_tidy_gate.sh tests/fixtures/clang_tidy/null_deref.c
      - name: Set up Emscripten
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: 3.1.57
      - name: Cache build directory
        uses: actions/cache@v4
        with:
          path: build/${{ matrix.preset }}
          key: ${{ runner.os }}-${{ matrix.preset }}-${{ github.sha }}
      - name: Configure
        run: cmake --preset ${{ matrix.preset }}
      - name: Build
        run: cmake --build --preset ${{ matrix.preset }}
      - name: Test
        run: ctest --preset ${{ matrix.preset }}
      - name: Verify linker guard flags
        run: |
          required=$(grep -E "^NT_FAILFAST_LINK_FLAGS:STRING=" build/${{ matrix.preset }}/CMakeCache.txt | cut -d= -f2)
          ci/scripts/check-linker-flags.sh --command-file build/${{ matrix.preset }}/CMakeFiles/nt_sandbox.dir/link.txt --required "$required"
      - name: Generate size reports (parallel)
        run: |
          set -euo pipefail
          folders=(sandbox/wasm/debug sandbox/wasm/release)
          declare -a pids=()
          for folder in "${folders[@]}"; do
            echo "Running size report for ${folder}"
            python3 reports/size/update.py --input "reports/size/${folder}" --output "${folder}" &
            pids+=($!)
          done
          status=0
          for pid in "${pids[@]}"; do
            if ! wait "${pid}"; then
              status=1
            fi
          done
          exit "${status}"
      - name: Generate quality gate report
        run: |
          ci/scripts/quality-gate-report.sh \
            --preset ${{ matrix.preset }} \
            --workflow web-release \
            --build-dir build/${{ matrix.preset }} \
            --output build/${{ matrix.preset }}/quality-gate-report.json \
            --warnings-as-errors true \
            --linker-status pass \
            --third-party "engine/third_party/cglm:Header-only cglm dependency"
      - name: Upload size-report artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.preset }}-reports
          path: |
            build/${{ matrix.preset }}/tests/size
            build/${{ matrix.preset }}/quality-gate-report.json
