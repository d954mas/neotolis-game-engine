openapi: 3.1.0
info:
  title: Fail-Fast Quality Gate API
  version: 0.1.0
servers:
  - url: https://ci.nt-engine.local/api
paths:
  /quality-gate/reports:
    post:
      summary: Publish the per-preset quality gate report generated by CI
      operationId: publishQualityGateReport
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/QualityGateReport'
      responses:
        '202':
          description: Report accepted and stored for audit/history
        '400':
          description: Invalid schema or missing required sections
  /quality-gate/reports/{preset}:
    get:
      summary: Retrieve the latest quality gate report for a preset
      operationId: getQualityGateReport
      parameters:
        - name: preset
          in: path
          required: true
          schema:
            type: string
            enum: [web-debug, web-release, win-debug, win-release]
      responses:
        '200':
          description: Latest report for the preset
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QualityGateReport'
        '404':
          description: No report exists for the preset
  /microbench/baselines:
    post:
      summary: Update the release baseline used for regression detection
      operationId: updateMicrobenchBaseline
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MicrobenchBaseline'
      responses:
        '200':
          description: Baseline updated
        '409':
          description: Baseline older than existing record
  /policies/{preset}:
    get:
      summary: Fetch the effective fail-fast policy for a preset
      operationId: getFailfastPolicy
      parameters:
        - name: preset
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Policy definition
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FailfastPolicy'
components:
  schemas:
    QualityGateReport:
      type: object
      required:
        - preset
        - compiler_flags
        - sanitizer_matrix
        - static_analysis
        - formatting
        - binary_budget
        - memory_policy
        - microbench
        - metadata
      properties:
        preset:
          type: string
        compiler_flags:
          type: object
          required: [warnings_as_errors, flag_list]
          properties:
            warnings_as_errors:
              type: boolean
            flag_list:
              type: array
              items:
                type: string
        sanitizer_matrix:
          type: object
          required: [enabled, components, coverage_pct]
          properties:
            enabled:
              type: boolean
            components:
              type: array
              items:
                type: string
            coverage_pct:
              type: number
              format: float
        static_analysis:
          type: object
          required: [violations, new_violations, status]
          properties:
            violations:
              type: integer
            new_violations:
              type: integer
            status:
              type: string
              enum: [pass, fail]
        formatting:
          type: object
          required: [drift_files, status]
          properties:
            drift_files:
              type: integer
            status:
              type: string
              enum: [pass, fail]
        binary_budget:
          type: object
          required: [wasm_delta_kb, native_delta_kb, status]
          properties:
            wasm_delta_kb:
              type: number
              format: float
            native_delta_kb:
              type: number
              format: float
            status:
              type: string
              enum: [pass, fail]
        memory_policy:
          type: object
          required: [runtime_ram_bytes, sanitizer_shadow_bytes, status]
          properties:
            runtime_ram_bytes:
              type: integer
            sanitizer_shadow_bytes:
              type: integer
            status:
              type: string
              enum: [pass, fail]
        microbench:
          type: object
          required: [median_ms, regression_pct, status]
          properties:
            median_ms:
              type: number
              format: float
            regression_pct:
              type: number
              format: float
            status:
              type: string
              enum: [pass, fail]
        metadata:
          type: object
          required: [commit, timestamp]
          properties:
            commit:
              type: string
            timestamp:
              type: string
              format: date-time
    MicrobenchBaseline:
      type: object
      required: [preset, median_ms, collected_at]
      properties:
        preset:
          type: string
          enum: [web-release, win-release]
        median_ms:
          type: number
          format: float
        collected_at:
          type: string
          format: date-time
    FailfastPolicy:
      type: object
      required:
        - warning_level
        - sanitizer_mask
        - heap_guard_mode
        - policy_hash
        - reaction
      properties:
        warning_level:
          type: string
          enum: [strict]
        sanitizer_mask:
          type: array
          items:
            type: string
        heap_guard_mode:
          type: string
          enum: [none, frame_guard, deep_guard]
        policy_hash:
          type: string
        reaction:
          type: string
          enum: [abort, log]
