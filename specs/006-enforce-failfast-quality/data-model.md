# Data Model — Fail-Fast Quality Enforcement

## Entity: `nt_failfast_policy`

- **Purpose**: Describes the active fail-fast configuration (warning tier, sanitizer usage, heap guard depth, reporting behavior) applied per preset.
- **Fields**:
  - `warning_level` (enum: strict, permissive) — must be `strict` for all presets in this feature.
  - `sanitizer_mask` (bitfield) — combinations of `{address, undefined, integer_trap}`; must be non-zero in debug presets, zero in release.
  - `heap_guard_mode` (enum: none, frame_guard, deep_guard) — debug presets use `frame_guard`; release presets may downgrade to `none` but must log the downgrade.
  - `policy_hash` (string, 8 chars) — compile-time identifier included in logs/artifacts.
  - `reaction` (enum: abort, log) — `abort` for debug, `log` for release (still accompanied by non-zero status code).
- **Relationships**: Referenced by scheduler (`nt_engine.c`) and CI tooling; embedded in quality gate reports.
- **Validation Rules**:
  - `sanitizer_mask` must align with preset type (debug vs. release) and toolchain availability.
  - `warning_level` cannot be downgraded without CI waiver.
  - `policy_hash` must match preset compile definition (`NT_FAILFAST_POLICY_HASH`).

## Entity: `nt_failfast_violation_snapshot`

- **Purpose**: Captures minimal diagnostic information whenever `NT_FAILFAST_ASSERT` triggers.
- **Fields**:
  - `stage_label` (string ≤32 chars) — where the violation occurred; required.
  - `expression` (string ≤96 chars) — failing condition; required.
  - `thread_id` (uint32) — obtained from existing threading util; required.
  - `policy_hash` (string, matches policy) — ensures report traceability.
  - `timestamp_us` (uint64) — monotonic timestamp used for ordering.
- **Relationships**: Generated by macros in `nt_engine.h`, consumed by logging backend and CI artifact generator.
- **Validation Rules**:
  - Must fit within ≤256 bytes stack usage.
  - `policy_hash` must correspond to currently applied policy.
  - `stage_label` values should be from a predefined set (`frame_begin`, `frame_end`, `sandbox_pre_draw`, etc.) for consistent dashboards.

## Entity: `nt_quality_gate_result`

- **Purpose**: Summarizes per-preset quality metrics for CI artifacts and release approvals.
- **Fields**:
  - `preset` (string) — e.g., `web-debug`.
  - `compiler_flags` (object) — includes `warnings_as_errors` (bool), `flag_list` (array of strings).
  - `sanitizer_matrix` (object) — `enabled` (bool), `components` (array), `coverage_pct` (float).
  - `static_analysis` (object) — `violations` (int), `new_violations` (int), `status` (pass/fail).
  - `formatting` (object) — `drift_files` (int), `status`.
  - `binary_budget` (object) — `wasm_delta_kb` (float), `native_delta_kb` (float), `status`.
  - `memory_policy` (object) — `runtime_ram_bytes` (int), `sanitizer_shadow_bytes` (int), `status`.
  - `microbench` (object) — `median_ms` (float), `regression_pct` (float), `status`.
- **Relationships**: JSON artifact consumed by release checklists; referenced in success criteria.
- **Validation Rules**:
  - `status` fields must transition to `fail` if thresholds exceeded (warnings>0, regressions>0.5%, etc.).
  - `preset` governs expected sanitizer/binary budgets (debug vs. release).
  - Artifact must include commit SHA metadata for audit linking.
