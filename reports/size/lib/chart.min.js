/*! Minimal Chart.js-compatible renderer for size dashboard.
 * Supports type: 'bar' with two datasets for HEAD / MASTER comparison.
 */
(function (global) {
    'use strict';

    var DEFAULT_COLORS = ['#2563eb', '#94a3b8', '#16a34a', '#f97316'];

    function Chart(ctx, config) {
        if (!(this instanceof Chart)) return new Chart(ctx, config);
        this.ctx = ctx && ctx.canvas ? ctx.canvas.getContext('2d') : ctx;
        this.config = config || {};
        this._render();
    }

    Chart.prototype.update = function (newConfig) {
        if (newConfig) {
            this.config = newConfig;
        }
        this._render();
    };

    Chart.prototype.destroy = function () {
        if (this.ctx) {
            this.ctx.clearRect(0, 0, this.ctx.canvas.width, this.ctx.canvas.height);
        }
    };

    Chart.prototype._render = function () {
        var ctx = this.ctx;
        if (!ctx) {
            console.error('chart.min.js: missing canvas context');
            return;
        }

        var config = this.config || {};
        if ((config.type || 'bar') !== 'bar') {
            console.warn('chart.min.js: only type="bar" is supported in this stub');
        }
        var data = config.data || {};
        var labels = data.labels || [];
        var datasets = data.datasets || [];

        ctx.save();
        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);

        if (!labels.length || !datasets.length) {
            ctx.fillStyle = '#6b7280';
            ctx.font = '16px sans-serif';
            ctx.fillText('No data available', 20, 40);
            ctx.restore();
            return;
        }

        var padding = 60;
        var width = ctx.canvas.width;
        var height = ctx.canvas.height;
        var chartWidth = width - padding * 2;
        var chartHeight = height - padding * 2;
        var barGroups = labels.length;
        var barsPerGroup = datasets.length;
        var groupWidth = chartWidth / Math.max(barGroups, 1);
        var barWidth = Math.max((groupWidth * 0.7) / Math.max(barsPerGroup, 1), 8);

        var maxValue = 0;
        datasets.forEach(function (dataset) {
            (dataset.data || []).forEach(function (value) {
                if (typeof value === 'number') {
                    maxValue = Math.max(maxValue, value);
                }
            });
        });
        if (maxValue === 0) {
            maxValue = 1;
        }
        var yStep = Math.pow(10, Math.floor(Math.log10(maxValue)));
        var yMax = Math.ceil(maxValue / yStep) * yStep;

        // Axes
        ctx.strokeStyle = '#cbd5f5';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(padding, padding);
        ctx.lineTo(padding, height - padding);
        ctx.lineTo(width - padding, height - padding);
        ctx.stroke();

        // Grid lines and labels
        ctx.fillStyle = '#475569';
        ctx.font = '12px sans-serif';
        var numTicks = 5;
        for (var i = 0; i <= numTicks; i++) {
            var value = (yMax / numTicks) * i;
            var y = height - padding - (chartHeight * (value / yMax));
            ctx.strokeStyle = '#e2e8f0';
            ctx.beginPath();
            ctx.moveTo(padding, y);
            ctx.lineTo(width - padding, y);
            ctx.stroke();
            ctx.fillText(formatNumber(value), 10, y + 4);
        }

        // Draw bars
        labels.forEach(function (label, groupIndex) {
            var groupX = padding + groupWidth * groupIndex + groupWidth / 2;
            ctx.fillStyle = '#1f2937';
            ctx.save();
            ctx.translate(groupX, height - padding + 20);
            ctx.rotate(-Math.PI / 6);
            ctx.fillText(label, 0, 0);
            ctx.restore();

            datasets.forEach(function (dataset, datasetIndex) {
                var value = dataset.data[groupIndex] || 0;
                var barHeight = chartHeight * (value / yMax);
                var barX = groupX - (barWidth * barsPerGroup) / 2 + datasetIndex * barWidth + datasetIndex * 4;
                var barY = height - padding - barHeight;
                ctx.fillStyle = dataset.backgroundColor || DEFAULT_COLORS[datasetIndex % DEFAULT_COLORS.length];
                ctx.fillRect(barX, barY, barWidth, barHeight);
            });
        });

        // Legend
        var legendX = width - padding - 140;
        var legendY = padding - 30;
        datasets.forEach(function (dataset, index) {
            ctx.fillStyle = dataset.backgroundColor || DEFAULT_COLORS[index % DEFAULT_COLORS.length];
            ctx.fillRect(legendX, legendY + index * 18, 12, 12);
            ctx.fillStyle = '#1f2937';
            ctx.fillText(dataset.label || 'Dataset ' + (index + 1), legendX + 18, legendY + 10 + index * 18);
        });

        ctx.restore();
    };

    function formatNumber(value) {
        if (value >= 1e9) return (value / 1e9).toFixed(1) + 'B';
        if (value >= 1e6) return (value / 1e6).toFixed(1) + 'M';
        if (value >= 1e3) return (value / 1e3).toFixed(1) + 'K';
        return String(Math.round(value));
    }

    global.Chart = Chart;
})(typeof window !== 'undefined' ? window : this);
